// Add this route to your admin routes
router.post('/send-mass-email', adminAuth, async (req, res) => {
  try {
    const { subject, htmlContent, recipientType } = req.body;
    
    if (!subject || !htmlContent) {
      return res.status(400).json({ message: "Subject and email content are required" });
    }
    
    // Build query for finding users based on recipientType
    let query = {};
    if (recipientType === 'active') {
      query.isActive = true;
    } else if (recipientType === 'inactive') {
      query.isActive = false;
    }
    
    // Get all users or filtered users
    const users = await User.find(query).select('email name');
    
    if (users.length === 0) {
      return res.status(404).json({ message: "No recipients found matching your criteria" });
    }
    
    // Send email to all users
    for (const user of users) {
      await sendEmail({
        to: user.email,
        subject: subject,
        html: htmlContent,
        // You can personalize emails here if needed
        // html: htmlContent.replace('{{name}}', user.name)
      });
    }
    
    res.status(200).json({ 
      message: "Mass email sent successfully", 
      recipientCount: users.length 
    });
    
  } catch (error) {
    console.error('Error in send-mass-email:', error);
    res.status(500).json({ message: "Failed to send emails" });
  }
});